<!DOCTYPE html>
<html>

<head>
<link rel="stylesheet" type="text/css" href="bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="mystyle.css">


<script src="jquery.js" ></script>
<script src="bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sheetrock/1.0.1/dist/sheetrock.min.js"></script>
<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://code.highcharts.com/mapdata/countries/us/us-all.js"></script>
<script src="https://code.highcharts.com/maps/modules/drilldown.js"></script>
<link href="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
<script src="http://code.highcharts.com/mapdata/countries/us/us-tx-all.js"></script>

</head>

<body>

<div class="row">
  <div class="col-md-4">
	<div class="page-header">
		<h4>Voter ID Requirements</h4>
	</div>

				<div class="checkbox">
						<label><input type="checkbox" value="NDR" name="voteID">No document required</label>
				</div>
				<div class="checkbox">
						<label><input type="checkbox" value="IRPNR" name="voteID">ID requested; photo not required</label>
				</div>
				<div class="checkbox">
						<label><input type="checkbox" value="PIR" name="voteID">Photo ID requested</label>
				</div>
				<div class="checkbox">
						<label><input type="checkbox" value="SNP" name="voteID">Strict Non-Photo ID</label>
				</div>
				<div class="checkbox">
						<label><input type="checkbox" value="SP" name="voteID">Strict Photo ID</label>
				</div>

<div class="page-header">
  <h4>Early Voting & Absentee Voting (AV) </h4>
</div>

				<div class="checkbox">
						<label><input type="checkbox" value="NER" name="early">NO EV and reason required for AV</label>
				</div>
				<div class="checkbox">
						<label><input type="checkbox" value="ER" name="early">EV and reason required for AV</label>
				</div>
				<div class="checkbox">
						<label><input type="checkbox" value="ENR" name="early">EV and NO reason required for AV</label>
				</div>
				
				<div class="checkbox">
						<label><input type="checkbox" value="AMV" name="early"> All-mail voting</label>
				</div>

<div class="page-header">
  <h4>Party Control of State Legislature</h4>
</div>

	<div class="checkbox">
		<label><input type="checkbox" value="Republican" name="state">Republican</label>
	</div>
  <div class="checkbox">
		<label><input type="checkbox" value="Democrat" name="state">Democrat</label>
	</div>
	<div class="checkbox">
		<label><input type="checkbox" value="Split" name="state">Split</label>
	</div>
	<div class="checkbox">
		<label><input type="checkbox" value="Non-partisan" name="state">Non-partisan</label>
	</div>
	
<div class="page-header">
	<h4>Same Day Voting Registration</h4>
</div>

<div>
	<label class="checkbox-inline"><input type="checkbox" value="Yes" name="same">Yes</label>
  <label class="checkbox-inline"><input type="checkbox" value="No" name="same">No</label>
</div>

<div class="page-header">
	<h4>Swing State</h4>
</div>

<div>
	<label class="checkbox-inline"><input type="checkbox" value="Yes" name="swing">Yes</label>
  <label class="checkbox-inline"><input type="checkbox" value="No" name="swing">No</label>
</div>

<div>
</div>

<div class="text-center">
<button id="apply" type="button" class="btn btn-primary">Apply Filters</button>
<button id="clear" type="button" class="btn btn-secondary">Clear Filters</button>
</div>



</div> 

<div class="col-md-8" id='tableSection' style="padding-top: 30pt;">
<table id="statistics" class="table table-condensed table-striped" hidden></table>
<div id="container" style="height: 700px; min-width: 310px; max-width: 800px; margin: 0 auto">
</div>
</div>
<div class="col-md-8">
	
<script>
$( document ).ready(function(){

  var mySpreadsheet = 'https://docs.google.com/spreadsheets/d/1U9Yj8hcrI8AFKB46iS7eSN_MAuwhQaLaPQCFWRGqlU0/edit#gid=0';
	//var mySpreadsheet = 'https://docs.google.com/spreadsheets/d/1qT1LyvoAcb0HTsi2rHBltBVpUBumAUzT__rhMvrz5Rk/edit#gid=0';
	
	// Load an entire worksheet.

	var requests = {}
	var queryString = "init"; 
	var stateData; 
	var title = "No Filtering"; 
	
	var myCallback = function (error, options, response) {
		if (!error) {
			//Will need to investigate further. 
			requests[queryString] = [];
			for (var i = 0; i < response.rows.length; i++) {
				requests[queryString].push(response.rows[i].cellsArray[0]); 
			}
		}else{
			console.log("NO!"); 
			console.log(error);
		}
		
		stateData = requests[queryString]
		console.log(stateData); 
		createMap(stateData, title); 
	};

	//Get the initial data
	$('#statistics').sheetrock({
					url: mySpreadsheet,
					query: 'select * where A <> "State"',
					callback: myCallback
	});
	
	
	
	/*$('input:checkbox').click(function(){
		if($(this).prop('checked')){
			console.log($(this).val());
		}else{
			console.log("SUCK IT!"); 
		}
	}); */
	
	
	$('#apply').click(function(){
	
		$("#statistics").remove(); 
		
		$('#tableSection').append('<table id="statistics" class="table table-condensed table-striped" hidden></table>');

		var voteIDArr = []; 
		var earlyArr = []; 
		var stateArr = []; 
		var sameArr = []; 
		var swingArr = [];
		
		$("input:checkbox[name='voteID']:checked").each(function(){
			voteIDArr.push($(this).val());
		}); 
		$("input:checkbox[name='early']:checked").each(function(){
			earlyArr.push($(this).val());
		}); 
		$("input:checkbox[name='state']:checked").each(function(){
			stateArr.push($(this).val());
		}); 
		$("input:checkbox[name='same']:checked").each(function(){
			sameArr.push($(this).val());
		}); 
		$("input:checkbox[name='swing']:checked").each(function(){
			swingArr.push($(this).val());
		}); 
		
		console.log(voteIDArr.length); 
		console.log(earlyArr.length);
		console.log(stateArr.length); 
		console.log(sameArr.length);		
		console.log(swingArr.length); 
		
		if(voteIDArr.length == 0 && earlyArr == 0 && stateArr.length == 0 &&
		   sameArr.length == 0 && swingArr.length == 0){
			 createMap(requests["init"]);
			 
	  }else{
	
			queryString = "select * where"; 
			title = "States where"; 
			
			var before = false; 
			
			if(voteIDArr.length > 0 && before){
				queryString = queryString + " and ("; 
			}else if(voteIDArr.length > 0){
				queryString = queryString + " (";
				title =
			}
			
			if(voteIDArr.length > 0){
				before = true; 
				
				for(i = 0; i < voteIDArr.length; i++){
					if(i == 0){
						queryString = queryString + "C = \'" + voteIDArr[i] + "\'";
					}else{
						queryString = queryString + " or C = \'" + voteIDArr[i] + "\'";
					}
				}
			}
			
			if(voteIDArr.length > 0){
				queryString = queryString + ")"; 
			}
			
			if(earlyArr.length > 0 && before){
				queryString = queryString + " and ("; 
			}else if(earlyArr.length > 0){
				queryString = queryString + " ("; 
			}
			
			if(earlyArr.length > 0){
			
				before = true; 
				
				for(i = 0; i < earlyArr.length; i++){
					if(i == 0){
						queryString = queryString + "D = \'" + earlyArr[i] + "\'";
					}else{
						queryString = queryString + " or D = \'" + earlyArr[i] + "\'";
					}
				}
			}
			
			if(earlyArr.length > 0){
				queryString = queryString + ")"; 
			}
			
			if(stateArr.length > 0 && before){
				queryString = queryString + " and ("; 
			}else if(stateArr.length > 0){
				queryString = queryString + " ("; 
			}
			
			if(stateArr.length > 0){
			
				before = true; 
				
				for(i = 0; i < stateArr.length; i++){
					if(i == 0){
						queryString = queryString + "E = \'" + stateArr[i] + "\'";
					}else{
						queryString = queryString + " or E = \'" + stateArr[i] + "\'";
					}
				}
			}
			
			if(stateArr.length > 0){
				queryString = queryString + ")"; 
			}
		
			if(sameArr.length > 0 && before){
				queryString = queryString + " and ("; 
			}else if(sameArr.length > 0){
				queryString = queryString + " ("; 
			}
			
			if(sameArr.length > 0){
			
				before = true; 
				
				for(i = 0; i < sameArr.length; i++){
					if(i == 0){
						queryString = queryString + "F = \'" + sameArr[i] + "\'";
					}else{
						queryString = queryString + " or F = \'" + sameArr[i] + "\'";
					}
				}
			}
			
			if(sameArr.length > 0){
				queryString = queryString + ")"; 
			}
			
			if(swingArr.length > 0 && before){
				queryString = queryString + " and ("; 
			}else if(swingArr.length > 0){
				queryString = queryString + " ("; 
			}
			
			if(swingArr.length > 0){
			
				before = true; 
				
				for(i = 0; i < swingArr.length; i++){
					if(i == 0){
						queryString = queryString + "G = \'" + swingArr[i] + "\'";
					}else{
						queryString = queryString + " or G = \'" + swingArr[i] + "\'";
					}
				}
			}
			
			if(swingArr.length > 0){
				queryString = queryString + ")"; 
			}
			
			//queryString = queryString +" or A = 'State'"; 
			
			//console.log(queryString); 
			
			if(queryString in requests){
				createMap(requests[queryString], title); 
			}else{
				$('#statistics').sheetrock({
						url: mySpreadsheet,
						query: queryString,
						callback: myCallback
					});
			}
				
			
		}
	});
	
$('#clear').click(function(){
	$("#statistics").remove(); 
	$('#tableSection').append('<table id="statistics" class="table table-condensed table-striped" hidden></table>');
	
	$('input:checkbox').prop('checked', false);
	createMap(requests["init"], "No Filtering");
	//$('#container').highcharts().setTitle({text: 'YEAH'})
	
}); 

	function createMap(filteredStates, title) {

		var data = Highcharts.geojson(Highcharts.maps['countries/us/us-all']),
		// Some responsiveness
        small = $('#container').width() < 400;
     
		//console.log("YAS"); 
		console.log(filteredStates); 
		//filteredStates.splice(1, 1); 
		//filteredStates = ["Maryland", "Alaska"]
		//console.log(this.properties); 
		 $.each(data, function () {
				if(filteredStates.indexOf(this.name) == -1){
					this.value = 0; 
				}else{
					//console.log(this.name); 
					this.value = 1;
				}
		});
	
    // Instanciate the map
    $('#container').highcharts('Map', {
		
		
        title : {
                text : title
            },
        plotOptions: {
            map: {
                allAreas: false,
                joinBy: ['postal-code', 'code'],
                dataLabels: {
                    enabled: true,
                    color: '#FFFFFF',
                    format: '{point.code}',
                    style: {
                        fontWeight: 'bold'
                    }
                },
                mapData: Highcharts.maps['countries/us/us-all'],
                tooltip: {
                    headerFormat: '',
                    pointFormat: '{point.name}'
                }

            },
        },
				legend:{
					enabled: false
				},
				
				colorAxis: {
					min: 0, 
					minColor: '#4b96af',
					maxColor: '#4b96af'
				},
				series: [{
					data: data,
					mapData: Highcharts.maps['countries/us/us-tx-all'],
					joinBy: 'hc-key',
					states: {
						hover: {
							color: '#fa1'
						}
					}
				}]
    });
	};
}); 

</script>
</body>
</html>